## 1、程序内存

### **1、User space 与 Kernel space**

现代的应用程序都运行在一个内存空间里，在 32 位系统中，这个内存空间拥有 4GB （2 的 32 次方）的寻址能力。

尽管现在的内存空间都号称是平坦的，但实际上内存仍然在不同的地址区间有着不同的地位，例如，大多数操作系统都会将 4GB 的内存空间一部分挪给内核使用，应用程序无法直接访问这一段内存，这一部分内存地址被称为 内核空间。

> Windows 在默认的情况下会将高地址的 2GB 空间分配给内核（也可以配置 1GB）。
> Linux 默认情况下将高地址的 1GB 空间分配给内核。

用户使用的剩下的 2GB 或 3GB 的内存空间称为用户空间。

**为什么要区分内核空间和用户空间？**

大致有三点因素：

第一点：操作系统的数据都是存放于系统空间的，用户进程的数据是存放于用户空间的；

第二点：分开来存放，就让系统的数据和用户的数据互不干扰，保证系统的稳定性，并且管理上很方便；

第三点：也是重要的一点，将用户的数据和系统的数据隔离开，就可以对两部分的数据的访问进行控制。这样就可以确保用户程序不能随便操作系统的数据，这样防止用户程序误操作或者是恶意破坏系统。

kernel space 是 Linux 内核的运行空间，User space 是用户程序的运行空间。为了安全，它们是隔离的，即使用户的程序崩溃了，内核也不受影响。

Kernel space 可以执行任意命令，调用系统的一切资源；

相对来说，User space 执行的是较为简单的运算，执行的运算不影响其他程序的执行，并且不能直接调用系统资源，必须通过系统接口（又称 system call），才能向内核发出指令。

### 2、堆栈内存

编程经常需要操作的内存

![img](https://ask.qcloudimg.com/http-save/6958268/n9yvwbfccs.png?imageView2/2/w/1620);

- 栈区(stack):由编译器自动分配和释放，存放函数的参数值、局部变量的值等。其操作方式类似于数据结构中的栈。
- 堆区(heap):一般由程序员分配和释放，若程序员不释放，程序结束时可能由操作系统回收。它与数据机构中的堆是两回事，分配方式类似于链表。
- 全局区(静态区)(static):全局变量和静态变量的存储是放在一起的，初始化的全局变量和静态变量在一块区域，未初始化的全局变量和未初始化的静态变量在相邻的另外一块区域。程序结束后由系统释放。
- 文字常量区:常量字符串就是放在这里。程序结束后由系统释放。
- 程序代码区:存放函数体的二进制代码

#### 堆和栈的区别

#### 1申请方式

- 栈：**由系统自动分配**。例如在声明函数的一个局部变量int b，系统自动在栈中为b开辟空间。
- 堆：**需要程序员自己申请**，并指明大小，在C中用malloc函数；在C++中用new运算符。

#### 2申请后系统的响应

- 栈：只要**栈的剩余空间大于所申请的空间**，**系统将为程序提供内存**，否则将报异常提示栈溢出 。
- 堆：**操作系统有一个记录空间内存地址的链表**，当系统收到程序的申请时，会遍历链表，**寻找第一个空间大于所申请空间的堆节点，然后将节点从内存空闲节点链表中删除，并将该节点的空间分配给程序**。对于大多数操作系统，会在这块内存空间中的首地址处记录本次分配的大小，这样，代码中的delete语句才能正确的释放本内存空间。另外，由于找到的对节点的大小不一定正好等于申请的大小，系统会自动地将多余的那部分重新放入到链表中。

#### 3申请大小的限制

- 栈：在Windows下，**栈是向低地址拓展的数据结构，是一块连续的内存的区域**。站定地址和栈的大小是系统预先规定好的，**如果申请的内存空间超过栈的剩余空间，将提示栈溢出**。
- 堆：堆是**向高地址拓展的内存结构**，是不连续的内存区域。是系统用链表存储空闲内存地址的，**不连续**。

#### 4申请效率的比较

- 栈：由系统自动分配，速度较快。但程序员无法控制。
- 堆：由new分配的内存，一般速度比较慢，而且容易产生内存碎片，不过用起来方便。 拓展：在Windows操作系统中，最好的方式使用VirtualAlloc分配内存。不是在堆，不是在栈，而是在内存空间中保留一块内存，虽然用起来不方便，但是速度快，也很灵活。

#### 5堆和栈的存储内容

- 栈：在函数调用时，第一个进栈的是主函数的中的下一条指令（函数调用的下一个可执行语句）的地址，然后是函数的各个参数。在C编译器中，参数是由右往左入栈的，然后是函数的局部变量。静态变量不入栈。
- 堆：一般是在堆的头部用一个字节存放堆的大小。堆中的具体内容由程序员安排。 数据结构方面的堆和栈与上边叙述不同。这里的堆是指优先队列的一种数据结构，第一个元素有最高的优先权；栈实际就是满足先进后出的性质的数学或数据结构。

总结： （1）heap是堆，stack是栈； （2）stack的空间由操作系统自动分配/释放，heap上的空间手动分配/释放； （3）stack空间有限，heap是很大的自由内存区； （4）C中的malloc函数分配的内存空间即在堆上，C++中对应的是new操作符。 程序在编译对变量和函数分配内存都在栈上进行，且内存运行过程中函数调用时参数的传递在栈上进行。
